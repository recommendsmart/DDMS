<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\node\Entity\NodeType;
use Drupal\node_singles\Access\SingleNodeAccessControlHandler;

/**
 * Implements @see hook_entity_operation_alter().
 */
function node_singles_entity_operation_alter(array &$operations, EntityInterface $entity)
{
    /** @var EntityInterface|null $single */
    $single = \Drupal::service('node_singles')->getSingleByBundle($entity->bundle());

    if ($entity->getEntityTypeId() !== 'node' || !$single) {
        return;
    }

    $operations['view'] = [
        'title' => t('View'),
        'weight' => 5,
        'url' => Url::fromRoute('entity.node.canonical', ['node' => $entity->id()]),
    ];

    if (!empty($operations['edit'])) {
        $operations['edit']['weight'] = 4;
    }

    if (!empty($operations['delete'])) {
        $operations['delete']['weight'] = 15;
    }

    $nodeType = NodeType::load($entity->bundle());
    $nodeTypeOperations = \Drupal::entityTypeManager()
        ->getListBuilder('node_type')
        ->getOperations($nodeType);

    if (isset($nodeTypeOperations['edit'])) {
        $nodeTypeOperations['edit']['title'] = t('Edit type');
        $nodeTypeOperations['edit-type'] = $nodeTypeOperations['edit'];
        unset($nodeTypeOperations['edit']);
    }

    $operations += $nodeTypeOperations;
}

/**
 * Implements @see hook_entity_insert().
 */
function node_singles_entity_insert(EntityInterface $entity)
{
    \Drupal::getContainer()
        ->get('node_singles.node_type_update.subscriber')
        ->checkForSingles($entity);
}

/**
 * Implements @see hook_entity_update().
 */
function node_singles_entity_update(EntityInterface $entity)
{
    \Drupal::getContainer()
        ->get('node_singles.node_type_update.subscriber')
        ->checkForSingles($entity);
}

/**
 * Implements @see hook_form_BASE_FORM_ID_alter().
 */
function node_singles_form_node_type_form_alter(array &$form, FormStateInterface $formState)
{
    \Drupal::getContainer()
        ->get('node_singles.node_type_form.subscriber')
        ->alterNodeTypeForm($form, $formState);
}

/**
 * Implements @see hook_form_BASE_FORM_ID_alter().
 */
function node_singles_form_node_form_alter(array &$form)
{
    \Drupal::getContainer()
        ->get('node_singles.node_form.subscriber')
        ->formAlter($form);
}

/**
 * Implements @see hook_entity_type_alter().
 */
function node_singles_entity_type_alter(array &$entityTypes): void
{
    $entityTypes['node']->setHandlerClass('access', SingleNodeAccessControlHandler::class);
}
